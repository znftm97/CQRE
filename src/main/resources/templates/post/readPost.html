<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>readPost</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrinkto-fit=no">
    <!-- Bootstrap CSS , jQuery-->
    <link rel="stylesheet" href="/css/bootstrap/bootstrap.min.css" integrity="sha384-
ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
          crossorigin="anonymous">
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
    <script th:src="@{/js/jquery-3.5.1.min.js}"> </script>
    <!-- Custom styles for this template -->
    <link rel="stylesheet" th:href="@{/css/common/fragments.css}">
    <link rel="stylesheet" th:href="@{/css/common/infoCommon.css}">
    <link rel="stylesheet" th:href="@{/css/board/freeCreate.css}">
    <link rel="stylesheet" th:href="@{/css/post/readPost.css}">
    <script th:src="@{/js/post/readPost.js}"></script>

</head>
<body>
<div class="containerCustom">
    <div th:replace="fragments/top :: top"/>
    <div class="postBox">
        <div class="boardTitle">
            <h2 th:text="${readPostDto.title}">제목</h2>
        </div>
        <div class="postInfo">
            <span>글쓴이 : </span>
            <span th:text="${readPostDto.userName}"></span>
            <span>, 조회수 : </span>
            <span th:text="${readPostDto.postViews}"></span>
            <span>, 작성시간 : </span>
            <span th:text="${readPostDto.lastModifiedDate}"></span>
        </div>

        <!--글 내용-->
        <div class="content">
            <p th:text="${readPostDto.content}"></p>
            <div>
                <i id="recommendationBtn"></i>
                <span>liked!</span>
                <input id="recommendationCheck" type="hidden" th:value="${recommendationCheck}"/>
            </div>
        </div><!--글 내용-->

        <!--첨부파일-->
        <span><strong>첨부파일</strong></span>

        <!--글 수정 삭제-->
        <div>
            <a class="btn-success" style="float: right" th:if="${readPostDto.authorCheck} == true"
               th:href="@{/post/update/{postId} (postId=${readPostDto.id})}">수정</a>
        </div>
        <form role="form" method="post" th:action="@{/post/remove/{postId} (postId=${readPostDto.id})}">
            <button type="submit" class="btn-danger" style="float: right; margin-right: 10px" th:if="${readPostDto.authorCheck} == true">삭제</button>
        </form> <!--글 수정 삭제-->

        <table>
            <tbody>
            <tr th:each="postFile : ${postFileDtos}">
                <td>
                    <a th:href="@{/postFile/download/{postFileId} (postFileId=${postFile.id})}" th:text="${postFile.originFilename}"></a>
                </td>
            </tr>
            </tbody>
        </table><!--첨부파일-->

        <!--댓글 박스-->
        <div class="commentBox" style="margin-top: 100px">
            <form style="display: flex" role="form" method="post" th:action="@{/comment/create}" th:object="${createCommentDto}">
                <input type="text" id="commentInput" class="form-control" placeholder="내용을 입력하세요" style="height: 60px"/>
                <button type="submit" class="btn btn-sm btn-primary" id="commentBtn" >Submit</button>
                <input type="hidden" th:value="${readPostDto.id}" id="postId">
            </form>

            <table class="table table-dark">
                <tbody>
                    <tr th:each="commentDto : ${commentDtos}">
                        <td style="float: left" th:text="${commentDto.username}"></td>
                        <td th:text="${commentDto.content}"></td>
                        <td th:text="${commentDto.lastModifiedDate}"></td>
                        <td style="float: right">
                            <form role="form" method="post" th:action="@{/comment/delete}">
                                <button id="updateBtn" class="btn-dark" style="float: right" >수정</button>
                                <input type="submit" th:value="삭제" id="removeBtn" class="btn-danger" style="float: right" th:formaction="@{/comment/delete/{commentId} (commentId=${commentDto.id})}"/>
                                <button id="reBtn" class="btn-success" style="float: right">답글</button>
                                <input type="hidden" th:value="${commentDto.id}">
                            </form>
                        </td>
                    </tr>
                </tbody>
                <tbody id="newTbody">
                </tbody>
            </table>

        <!--paging-->
        <nav style="text-align: center;">
            <ul class="pagination justify-content-center">

                <!--  first  -->
                <li class="page-item">
                    <a class="page-link"  aria-label="First">
                        <span aria-hidden="true">First</span>
                    </a>
                </li>

                <!--  <  -->
                <li class="page-item">
                    <a class="page-link" aria-label="Previous" >
                        <span aria-hidden="true">&lt;</span>
                    </a>
                </li>

                <!--  1,2,3  -->
                <li class="page-item">
                    <a class="page-link"></a>
                </li>

                <!--  > -->
                <li class="page-item">
                    <a class="page-link" aria-label="Next">
                        <span aria-hidden="true">&gt;</span>
                    </a>
                </li>

                <!--  Last  -->
                <li class="page-item">
                    <a class="page-link" aria-label="Last">
                        <span aria-hidden="true">Last</span>
                    </a>
                </li>
            </ul>
        </nav><!--paging-->
    </div><!--commetBox-->
</div> <!--postBox-->
</div><!--containerCustom-->

<script>
    /*추천 여부 확인*/
    let check = $("#recommendationCheck").val();
    console.log(check);
    if (check == "exist") {
        $( "i,span" ).toggleClass( "press", 1000 );
        console.log(check);
    }

    /*추천*/
    $("#recommendationBtn").on('click', function (e){
        let form = {
            postId: $("#postId").val()
        }
        console.log(form);

        $.ajax({
            url: "/recommendation",
            type: "post",
            data: JSON.stringify(form),
            contentType: "application/json; charset=utf-8",
        }).done(function (resp){

        }).fail(function (error){
            alert("실패");
        });
    });

    /*댓글 삭제*/
    $("#removeBtnAjax").on('click', function (e){
        e.preventDefault();
        let form = {
            commentId: $("#commentId").val()
        }

        $.ajax({
            url: "/comment/delete",
            type: "post",
            data: JSON.stringify(form),
            contentType: "application/json; charset=utf-8",
        }).done(function (resp) {
            alert(resp);
        }).fail(function (error) {
            alert(error);
        });

    })

    /*댓글 생성*/
    $("#commentBtn").on('click', function (e){
        e.preventDefault();
        let form ={
            content: $("#commentInput").val(),
            postId: $("#postId").val()
        };

        $.ajax({
            url: "/comment/create",
            type: "post",
            data: JSON.stringify(form),
            contentType: "application/json; charset=utf-8",
        }).done(function (resp){
            $.createComment = function (resp){
                var tr = document.createElement('tr')
                $("#newTbody").append(tr);

                var td1 = document.createElement('td');
                var text1 = document.createTextNode(resp.username);
                td1.append(text1);

                var td2 = document.createElement('td');
                var text2 = document.createTextNode(resp.content);
                td2.append(text2);

                var td3 = document.createElement('td');
                var text3 = document.createTextNode(resp.lastModifiedDate);
                td3.append(text3);

                var td4 = document.createElement('td');
                var formTag = document.createElement('form');
                formTag.method = "post";
                formTag.action = "/comment/delete";
                td4.append(formTag);

                var btn1 = document.createElement('button');
                btn1.innerText = "수정";
                btn1.className = "btn-dark";
                btn1.style.float = "right";
                btn1.id = "updateBtnAjax";

                var input2 = document.createElement('input');
                input2.value = "삭제";
                input2.className = "btn-danger";
                input2.style.float = "right";
                input2.id = "removeBtnAjax";
                input2.type = "submit";
                input2.formAction = "/comment/delete";

                var btn3 = document.createElement('button');
                btn3.innerText = "답글";
                btn3.className = "btn-success";
                btn3.style.float = "right";
                btn3.id = "reBtnAjax";

                var inputTag = document.createElement('input');
                var commentId = resp.id;
                inputTag.type = "hidden";
                inputTag.value = commentId;
                inputTag.id = "commentId"

                formTag.append(btn1);
                formTag.append(input2);
                formTag.append(btn3);
                formTag.append(inputTag);

                tr.append(td1);
                tr.append(td2);
                tr.append(td3);
                tr.append(td4);
            }
            if(resp.username == null){
                alert("로그인이 필요합니다.")
                location.href = "/user/sign";
            }else{
                $.createComment(resp);
            }

        }).fail(function (error){
            alert(JSON.stringify(error));
        });
    });
</script>
</body>
</html>
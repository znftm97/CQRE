<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>readPost</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrinkto-fit=no">
    <!-- Bootstrap CSS , jQuery-->
    <link rel="stylesheet" href="/css/bootstrap/bootstrap.min.css" integrity="sha384-
ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
          crossorigin="anonymous">
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
    <script th:src="@{/js/jquery-3.5.1.min.js}"> </script>
    <!-- Custom styles for this template -->
    <link rel="stylesheet" th:href="@{/css/common/fragments.css}">
    <link rel="stylesheet" th:href="@{/css/common/infoCommon.css}">
    <link rel="stylesheet" th:href="@{/css/board/freeCreate.css}">
    <link rel="stylesheet" th:href="@{/css/post/readPost.css}">
    <script th:src="@{/js/post/readPost.js}"></script>

</head>
<body>
<div class="containerCustom">
    <div th:replace="fragments/top :: top"/>
    <div class="postBox">
        <div class="boardTitle">
            <h2 th:text="${readPostDto.title}">제목</h2>
        </div>
        <div class="postInfo">
            <span>글쓴이 : </span>
            <span th:text="${readPostDto.userName}"></span>
            <span>, 조회수 : </span>
            <span th:text="${readPostDto.postViews}"></span>
            <span>, 작성시간 : </span>
            <span th:text="${readPostDto.lastModifiedDate}"></span>
        </div>
        <!--글 내용-->
        <div class="content">
            <p th:text="${readPostDto.content}"></p>
            <div>
                <i></i>
                <span>liked!</span>
            </div>
        </div><!--글 내용-->

        <p><strong>첨부파일</strong></p>
        <table>
            <tbody>
            <tr th:each="postFile : ${postFiles}">
                <td>
                    <a th:href="@{/postFile/download/{postFileId} (postFileId=${postFile.id})}" th:text="${postFile.originFilename}"></a>
                </td>
            </tr>
            </tbody>
        </table>

        <!--댓글 박스-->
        <div class="commentBox" style="margin-top: 100px">
            <form style="display: flex" role="form" method="post" th:action="@{/comment/create}" th:object="${createCommentDto}">
                <input type="text" id="commentInput" class="form-control" placeholder="내용을 입력하세요" style="height: 60px"/>
                <button type="submit" class="btn btn-sm btn-primary" id="commentBtn" >Submit</button>
                <input type="hidden" th:value="${readPostDto.id}" id="postId">
            </form>

            <table class="table table-dark">
                <tbody>
                    <tr th:each="commentDto : ${commentDtos}">
                        <td style="float: left" th:text="${commentDto.username}"></td>
                        <td th:text="${commentDto.content}"></td>
                        <td th:text="${commentDto.lastModifiedDate}"></td>
                        <td style="float: right">
                            <form role="form" method="post">
                                <button class="btn-danger" style="float: right">삭제</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
                <tbody id="newTbody">
                </tbody>
            </table>

        <!--paging-->
        <nav style="text-align: center;">
            <ul class="pagination justify-content-center">

                <!--  first  -->
                <li class="page-item">
                    <a class="page-link"  aria-label="First">
                        <span aria-hidden="true">First</span>
                    </a>
                </li>

                <!--  <  -->
                <li class="page-item">
                    <a class="page-link" aria-label="Previous" >
                        <span aria-hidden="true">&lt;</span>
                    </a>
                </li>

                <!--  1,2,3  -->
                <li class="page-item">
                    <a class="page-link"></a>
                </li>

                <!--  > -->
                <li class="page-item">
                    <a class="page-link" aria-label="Next">
                        <span aria-hidden="true">&gt;</span>
                    </a>
                </li>

                <!--  Last  -->
                <li class="page-item">
                    <a class="page-link" aria-label="Last">
                        <span aria-hidden="true">Last</span>
                    </a>
                </li>
            </ul>
        </nav><!--paging-->
    </div><!--commetBox-->
</div> <!--postBox-->
</div><!--containerCustom-->

<script>
    $("#commentBtn").on('click', function (e){
        e.preventDefault();
        let form ={
            content: $("#commentInput").val(),
            postId: $("#postId").val()
        };

        $.ajax({
            url: "/comment/create",
            type: "post",
            data: JSON.stringify(form),
            contentType: "application/json; charset=utf-8",
        }).done(function (resp){
            $.createComment = function (resp){
                var tr = document.createElement('tr')
                $("#newTbody").append(tr);

                var td1 = document.createElement('td');
                var text1 = document.createTextNode(resp.username);
                td1.append(text1);

                var td2 = document.createElement('td');
                var text2 = document.createTextNode(resp.content);
                td2.append(text2);

                var td3 = document.createElement('td');
                var text3 = document.createTextNode(resp.lastModifiedDate);
                td3.append(text3);

                var td4 = document.createElement('td');
                var btn = document.createElement('button');
                btn.innerText = "삭제";
                btn.className = "btn-danger";
                td4.append(btn);

                tr.append(td1);
                tr.append(td2);
                tr.append(td3);
                tr.append(td4)
            }
            if(resp.username == null){
                alert("로그인이 필요합니다.")
            }else{
                $.createComment(resp);
            }


        }).fail(function (error){
            alert(JSON.stringify(error));
        });
    });
</script>
</body>
</html>